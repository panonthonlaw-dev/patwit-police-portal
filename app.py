import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime, timedelta
import pytz, random, os, base64, io, qrcode, glob, math, json, requests, re, textwrap, time
from PIL import Image

# PDF Libraries
try:
    from weasyprint import HTML, CSS
    from weasyprint.text.fonts import FontConfiguration
except: pass
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4
from reportlab.lib.utils import ImageReader
import plotly.express as px

# ==========================================
# 1. INITIAL SETTINGS & SESSION STATE
# ==========================================
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

# ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô AttributeError (‡∏™‡∏£‡πâ‡∏≤‡∏á State ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ä‡∏∏‡∏î)
states = {
    "logged_in": False, "user_info": {}, "current_dept": None,
    "view_mode": "list", "selected_case_id": None, "unlock_password": "",
    "search_results_df": None, "edit_data": None, "reset_count": 0,
    "page_pending": 1, "page_finished": 1
}
for key, val in states.items():
    if key not in st.session_state: st.session_state[key] = val

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FONT_FILE = os.path.join(BASE_DIR, "THSarabunNew.ttf")

# Helpers
def get_now_th(): return datetime.now(pytz.timezone('Asia/Bangkok'))
def fix_key(key): return key.strip().replace("\\n", "\n") if key else ""
def get_img_link(url):
    match = re.search(r'/d/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)', str(url))
    file_id = match.group(1) or match.group(2) if match else None
    return f"https://drive.google.com/thumbnail?id={file_id}&sz=w800" if file_id else url

# ==========================================
# 2. MODULE: INVESTIGATION (‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô - ‡∏¢‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πä‡∏∞‡πÜ)
# ==========================================
def investigation_module():
    st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å", on_click=lambda: setattr(st.session_state, 'current_dept', None), width='stretch')
    user = st.session_state.user_info

    # --- ‡πÉ‡∏™‡πà Logic ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ---
    def safe_ensure_columns_for_view(df):
        cols = ['Report_ID', 'Timestamp', 'Reporter', 'Incident_Type', 'Location', 'Details', 'Status', 'Image_Data', 'Audit_Log', 'Victim', 'Accused', 'Witness', 'Teacher_Investigator', 'Student_Police_Investigator', 'Statement', 'Evidence_Image']
        df_new = df.copy()
        for c in cols:
            if c not in df_new.columns: df_new[c] = ""
        return df_new

    try:
        conn = st.connection("gsheets", type=GSheetsConnection)
        df_raw = conn.read(ttl="0")
        df_display = safe_ensure_columns_for_view(df_raw)
        df_display['Report_ID'] = df_display['Report_ID'].astype(str).str.replace(r'\.0$', '', regex=True)

        st.title("üìÇ ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
        
        # --- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö Expander / Pagination ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ---
        # (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Copy ‡πÅ‡∏ú‡∏á Dashboard ‡πÅ‡∏•‡∏∞ Loop ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
        st.subheader("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏")
        st.dataframe(df_display.tail(20), use_container_width=True)
        
    except Exception as e:
        st.error(f"‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")

# ==========================================
# 3. MODULE: TRAFFIC (‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£ - ‡∏¢‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πä‡∏∞‡πÜ)
# ==========================================
def traffic_module():
    st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å", on_click=lambda: setattr(st.session_state, 'current_dept', None), width='stretch')
    user = st.session_state.user_info
    
    st.title("üö¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")

    def connect_traffic():
        raw_json = st.secrets["textkey"]["json_content"].strip()
        info = json.loads(raw_json)
        info["private_key"] = fix_key(info["private_key"])
        creds = ServiceAccountCredentials.from_json_keyfile_dict(info, ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"])
        return gspread.authorize(creds).open("Motorcycle_DB").sheet1

    try:
        sheet = connect_traffic()
        
        # --- UI ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô (Metric Cards) ---
        if st.button("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", use_container_width=True):
            data = sheet.get_all_values()
            # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Column ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô App
            header = data[0]
            clean_header = []
            for i, name in enumerate(header):
                n = name.strip() or f"Col_{i}"
                if n in clean_header: n = f"{n}_{i}"
                clean_header.append(n)
            st.session_state.search_results_df = pd.DataFrame(data[1:], columns=clean_header)
            st.rerun()

        # --- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Card/Expander ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏≤‡∏à‡∏£‡πÄ‡∏î‡∏¥‡∏° ---
        q = st.text_input("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)")
        if st.session_state.search_results_df is not None:
            df = st.session_state.search_results_df
            if q:
                df = df[df.apply(lambda r: r.astype(str).str.contains(q, case=False).any(), axis=1)]
            
            for i, row in df.iterrows():
                with st.expander(f"üìç {row['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô']} | {row['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•']}"):
                    st.write(f"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {row['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô']}")
                    # ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                    
    except Exception as e:
        st.error(f"‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")

# ==========================================
# 4. MAIN GATEWAY & LOGIN
# ==========================================
def main():
    if not st.session_state.logged_in:
        _, col, _ = st.columns([1, 1.2, 1])
        with col:
            st.markdown("<br><br>", unsafe_allow_html=True)
            with st.container(border=True):
                st.markdown("<h2 style='text-align:center;'>üëÆ‚Äç‚ôÇÔ∏è Central Login</h2>", unsafe_allow_html=True)
                pwd_in = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", type="password")
                if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", width='stretch', type='primary'):
                    accounts = st.secrets.get("OFFICER_ACCOUNTS", {})
                    if pwd_in in accounts:
                        st.session_state.logged_in = True
                        st.session_state.user_info = accounts[pwd_in]
                        st.rerun()
                    else: st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î")
    else:
        # Sidebar
        user = st.session_state.user_info
        st.sidebar.markdown(f"### üë§ {user.get('name')}")
        if st.sidebar.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", width='stretch'):
            st.session_state.clear()
            st.rerun()

        if st.session_state.current_dept is None:
            st.title("üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô")
            c1, c2 = st.columns(2)
            with c1:
                with st.container(border=True):
                    st.subheader("üïµÔ∏è ‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", width='stretch', type='primary'):
                        st.session_state.current_dept = "inv"; st.rerun()
            with c2:
                with st.container(border=True):
                    st.subheader("üö¶ ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£", width='stretch', type='primary'):
                        st.session_state.current_dept = "tra"; st.rerun()
        else:
            if st.session_state.current_dept == "inv": investigation_module()
            else: traffic_module()

if __name__ == "__main__":
    main()
