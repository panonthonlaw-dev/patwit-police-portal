import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime, timedelta
import pytz
import random
import os
import base64
import io
import qrcode
import glob
import math
import time
import re
import json
import textwrap
import requests
import plotly.express as px

# --- PDF Libraries ---
from weasyprint import HTML, CSS
from weasyprint.text.fonts import FontConfiguration
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4
from reportlab.lib.utils import ImageReader
from PIL import Image

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ Session ---
st.set_page_config(page_title="‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏û‡∏±‡∏ó‡∏ß‡∏¥‡∏ó‡∏¢‡πå", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FONT_FILE = os.path.join(BASE_DIR, "THSarabunNew.ttf")
FONT_BOLD_FILE = os.path.join(BASE_DIR, "THSarabunNewBold.ttf")
LOGO_PATH = next((f for f in glob.glob(os.path.join(BASE_DIR, "school_logo*")) if f.lower().endswith(('.png','.jpg','.jpeg'))), None)

# ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö
if 'logged_in' not in st.session_state: st.session_state.logged_in = False
if 'current_dept' not in st.session_state: st.session_state.current_dept = None
if 'view_mode' not in st.session_state: st.session_state.view_mode = "list"
if 'traffic_page' not in st.session_state: st.session_state.traffic_page = 'search'

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢ (Helpers) ---
def get_now_th(): return datetime.now(pytz.timezone('Asia/Bangkok'))

def sanitize_input(text):
    if text: return str(text).replace("=", "").replace('"', "").replace("'", "").strip()
    return text

def get_base64_image(image_path):
    if not image_path or not os.path.exists(image_path): return ""
    with open(image_path, "rb") as f: return base64.b64encode(f.read()).decode()

LOGO_BASE64 = get_base64_image(LOGO_PATH) if LOGO_PATH else ""

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏Å‡∏±‡∏ô Error 50,000 chars)
def process_image_inv(img_file):
    if img_file is None: return ""
    try:
        img = Image.open(img_file)
        if img.mode in ('RGBA', 'LA', 'P'): img = img.convert('RGB')
        max_size, quality = 800, 65
        while True:
            img_copy = img.copy(); img_copy.thumbnail((max_size, max_size))
            buf = io.BytesIO(); img_copy.save(buf, format="JPEG", quality=quality, optimize=True)
            b64 = base64.b64encode(buf.getvalue()).decode()
            if len(b64) < 49000 or max_size < 200: return b64
            max_size = int(max_size * 0.7); quality -= 5
    except: return ""

# --- 3. [Module: Investigation] ‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô ---
conn_inv = st.connection("gsheets", type=GSheetsConnection)

def safe_ensure_inv_cols(df):
    cols = ['Report_ID', 'Timestamp', 'Reporter', 'Incident_Type', 'Location', 'Details', 'Status', 'Image_Data', 'Audit_Log', 'Victim', 'Accused', 'Witness', 'Teacher_Investigator', 'Student_Police_Investigator', 'Statement', 'Evidence_Image']
    if df is None or df.empty: return pd.DataFrame(columns=cols)
    df.columns = df.columns.str.strip()
    for c in cols:
        if c not in df.columns: df[c] = ""
    return df

def investigation_department():
    st.subheader("üïµÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏")
    user = st.session_state.current_user_data
    try:
        df_raw = conn_inv.read(ttl="0")
        df_display = safe_ensure_inv_cols(df_raw.copy()).fillna("")
        df_display['Report_ID'] = df_display['Report_ID'].astype(str).str.replace(r'\.0$', '', regex=True).str.strip()

        if st.session_state.view_mode == "list":
            tab_l, tab_s = st.tabs(["üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™", "üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥"])
            with tab_l:
                # ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô (‡∏¢‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤)
                st.write("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏...")
                # (‡πÅ‡∏ó‡∏£‡∏Å Logic ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á p_index ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
            with tab_s:
                # ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏µ % ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                st.write("‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô...")
    except Exception as e: st.error(f"Error Investigation: {e}")

# --- 4. [Module: Traffic] ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£ ---
def connect_traffic_sheet():
    key_dict = json.loads(st.secrets["textkey"]["json_content"])
    creds = ServiceAccountCredentials.from_json_keyfile_dict(key_dict, ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"])
    return gspread.authorize(creds).open("Motorcycle_DB").sheet1

def traffic_department():
    st.subheader("üö¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")
    # ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏¢‡∏Å‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏≤‡∏à‡∏£‡πÄ‡∏î‡∏¥‡∏°)
    st.info("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ / ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏à‡∏£‡∏≤‡∏à‡∏£")
    # (‡πÅ‡∏ó‡∏£‡∏Å Logic ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)

# --- 5. [Portal] ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (Department Selector) ---
def officer_portal():
    user = st.session_state.current_user_data
    h1, h2, h3 = st.columns([1, 5, 1])
    with h1: 
        if LOGO_PATH: st.image(LOGO_PATH, width=80)
    with h2:
        st.markdown(f"#### üè¢ ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤\n**‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:** {user['name']} | **‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:** {user['role']}")
    with h3:
        if st.button("üö™ Logout", use_container_width=True):
            st.session_state.logged_in = False; st.session_state.current_dept = None; st.rerun()

    st.markdown("---")
    if st.session_state.current_dept is None:
        st.markdown("<h3 style='text-align:center;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>", unsafe_allow_html=True)
        c1, c2 = st.columns(2)
        if c1.button("üïµÔ∏è ‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô / ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏", use_container_width=True, height=150):
            st.session_state.current_dept = "inv"; st.rerun()
        if c2.button("üö¶ ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£ / ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ", use_container_width=True, height=150):
            st.session_state.current_dept = "traffic"; st.rerun()
    else:
        if st.button("üîÑ ‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å"): st.session_state.current_dept = None; st.rerun()
        if st.session_state.current_dept == "inv": investigation_department()
        else: traffic_department()

# --- 6. ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Public Page) ---
def public_page():
    if LOGO_PATH:
        c1, c2, c3 = st.columns([5, 1, 5])
        c2.image(LOGO_PATH, width=100)
    st.markdown("<h1 style='text-align: center; color: #1E3A8A;'>üëÆ‚Äç‚ôÇÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</h1>", unsafe_allow_html=True)
    
    t1, t2 = st.tabs(["üìù ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏î‡πà‡∏ß‡∏ô (‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô)", "üèçÔ∏è ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ (‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£)"])
    
    with t1:
        # ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏á‡∏≤‡∏ô‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô
        with st.form("inv_form"):
            st.write("‡πÅ‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå")
            rep = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á")
            loc = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà")
            det = st.text_area("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î *", placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏∞‡πÑ‡∏£ ‡∏ó‡∏µ‡πà‡πÉ‡∏î ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î(‡∏ñ‡πâ‡∏≤‡∏ó‡∏£‡∏≤‡∏ö)")
            if st.form_submit_button("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏"):
                st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)")

    with t2:
        # ‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        st.write("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï")
        if st.button("üÜî ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏±‡∏ï‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Student Portal)"): pass
        if st.button("üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà"): pass

    st.markdown("---")
    with st.expander("üîê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (Login)"):
        pwd = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", type="password")
        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"):
            accounts = st.secrets.get("OFFICER_ACCOUNTS", {})
            if pwd in accounts:
                st.session_state.logged_in = True
                st.session_state.current_user_data = accounts[pwd]
                st.rerun()
            else: st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

# --- 7. ‡∏£‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ---
if st.session_state.logged_in:
    officer_portal()
else:
    public_page()
