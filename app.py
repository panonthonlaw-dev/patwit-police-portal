import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import json, os, re, pytz, base64
from datetime import datetime

# ==========================================
# 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞ SESSION STATE
# ==========================================
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

# ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
if "logged_in" not in st.session_state: st.session_state.logged_in = False
if "current_user" not in st.session_state: st.session_state.current_user = None
if "current_dept" not in st.session_state: st.session_state.current_dept = None

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Incorrect padding)
def get_clean_key(key_str):
    if not key_str: return ""
    return key_str.strip().replace("\\n", "\n")

# ==========================================
# 2. ‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô (INVESTIGATION)
# ==========================================
def investigation_module():
    st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å", on_click=lambda: setattr(st.session_state, 'current_dept', None), width='stretch')
    st.title("üìÇ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
    
    try:
        # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Secrets
        conn = st.connection("gsheets", type=GSheetsConnection)
        df = conn.read(ttl="0")
        st.success("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        
        st.subheader("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")
        st.dataframe(df.tail(10), use_container_width=True)
        st.info("üí° ‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ")
    except Exception as e:
        st.error(f"‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {str(e)}")

# ==========================================
# 3. ‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£ (TRAFFIC)
# ==========================================
def traffic_module():
    st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å", on_click=lambda: setattr(st.session_state, 'current_dept', None), width='stretch')
    st.title("üö¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")
    
    try:
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô [textkey]
        raw_info = json.loads(st.secrets["textkey"]["json_content"])
        raw_info["private_key"] = get_clean_key(raw_info["private_key"])
        
        scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(raw_info, scope)
        client = gspread.authorize(creds)
        
        # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Motorcycle_DB
        sheet = client.open("Motorcycle_DB").sheet1
        st.success("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        
        if st.button("üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"):
            data = sheet.get_all_records()
            st.dataframe(pd.DataFrame(data), use_container_width=True)
    except Exception as e:
        st.error(f"‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {str(e)}")

# ==========================================
# 4. ‡∏£‡∏∞‡∏ö‡∏ö LOGIN ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (GATEWAY)
# ==========================================
def main():
    if not st.session_state.logged_in:
        # --- ‡∏´‡∏ô‡πâ‡∏≤ LOGIN ---
        _, col, _ = st.columns([1, 1.5, 1])
        with col:
            st.markdown("<br><br>", unsafe_allow_html=True)
            with st.container(border=True):
                st.markdown("<h2 style='text-align:center;'>üëÆ‚Äç‚ôÇÔ∏è Central Login</h2>", unsafe_allow_html=True)
                st.markdown("<p style='text-align:center;'>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</p>", unsafe_allow_html=True)
                
                pwd = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", type="password")
                if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True, type="primary"):
                    accounts = st.secrets.get("officer_accounts", {})
                    if pwd in accounts:
                        st.session_state.logged_in = True
                        st.session_state.current_user = accounts[pwd]
                        st.rerun()
                    else:
                        st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
    else:
        # --- ‡∏´‡∏•‡∏±‡∏á LOGIN ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ---
        user = st.session_state.current_user
        name = user['name'] if isinstance(user, dict) and 'name' in user else "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà"
        
        st.sidebar.markdown(f"### üë§ {name}")
        if st.sidebar.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True):
            st.session_state.clear()
            st.rerun()

        if st.session_state.current_dept is None:
            # --- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å ---
            st.header("üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô")
            st.divider()
            c1, c2 = st.columns(2)
            with c1:
                with st.container(border=True):
                    st.subheader("üïµÔ∏è ‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
                    st.write("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏î‡∏µ")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", use_container_width=True):
                        st.session_state.current_dept = "inv"
                        st.rerun()
            with c2:
                with st.container(border=True):
                    st.subheader("üö¶ ‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏≤‡∏à‡∏£")
                    st.write("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏à‡∏£‡∏≤‡∏à‡∏£")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£", use_container_width=True):
                        st.session_state.current_dept = "tra"
                        st.rerun()
        else:
            # --- ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ù‡πà‡∏≤‡∏¢ ---
            if st.session_state.current_dept == "inv": investigation_module()
            elif st.session_state.current_dept == "tra": traffic_module()

if __name__ == "__main__":
    main()
