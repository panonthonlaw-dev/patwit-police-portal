import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime, timedelta
import pytz, random, os, base64, io, qrcode, glob, math, mimetypes, json, requests, re, textwrap, time, ast
from PIL import Image
import gspread
from oauth2client.service_account import ServiceAccountCredentials

# PDF & Chart Libraries
try:
    from weasyprint import HTML, CSS
    from weasyprint.text.fonts import FontConfiguration
except: pass
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4
from reportlab.lib.utils import ImageReader
import plotly.express as px
import plotly.graph_objects as go

# ==========================================
# 1. INITIAL SETTINGS & SESSION MANAGEMENT
# ==========================================
st.set_page_config(page_title="‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏Ø", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide", initial_sidebar_state="collapsed")

# --- 1.1 CSS ‡∏ã‡πà‡∏≠‡∏ô UI Streamlit (GitHub/Menu/Sidebar) ---
st.markdown("""
<style>
    #MainMenu {visibility: hidden;} footer {visibility: hidden;} header {visibility: hidden;} .stDeployButton {display:none;}
    [data-testid="stSidebar"] {display: none;} [data-testid="collapsedControl"] {display: none;}
    .metric-card { background: white; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .metric-value { font-size: 2.2rem; font-weight: 800; color: #1e293b; } .metric-label { font-size: 0.9rem; color: #64748b; }
</style>
""", unsafe_allow_html=True)

# --- 1.2 Session & Timeout Logic (15 ‡∏ô‡∏≤‡∏ó‡∏µ) ---
TIMEOUT_SECONDS = 15 * 60 
def check_inactivity():
    if 'last_active' not in st.session_state:
        st.session_state.last_active = time.time()
        return
    if time.time() - st.session_state.last_active > TIMEOUT_SECONDS:
        st.session_state.clear()
        st.session_state.timeout_msg = "‚è≥ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (15 ‡∏ô‡∏≤‡∏ó‡∏µ) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà"
        st.rerun()
    else:
        st.session_state.last_active = time.time()

check_inactivity()

# State Initialization
states = {
    'logged_in': False, 'user_info': {}, 'current_dept': None,
    'view_mode': 'list', 'selected_case_id': None, 'unlock_password': "",
    'page_pending': 1, 'page_finished': 1, 'search_query_main': "",
    'traffic_page': 'teacher', 'df_tra': None, 'search_results_df': None, 
    'current_user_pwd': "", 'edit_data': None
}
for key, val in states.items():
    if key not in st.session_state: st.session_state[key] = val

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FONT_FILE = os.path.join(BASE_DIR, "THSarabunNew.ttf")
FONT_BOLD = os.path.join(BASE_DIR, "THSarabunNewBold.ttf")

# Configs
SHEET_NAME_TRAFFIC = "Motorcycle_DB"
DRIVE_FOLDER_ID = "1WQGATGaGBoIjf44Yj_-DjuX8LZ8kbmBA"
GAS_APP_URL = "https://script.google.com/macros/s/AKfycbxRf6z032SxMkiI4IxtUBvWLKeo1LmIQAUMByoXidy4crNEwHoO6h0B-3hT0X7Q5g/exec"
UPGRADE_PASSWORD = st.secrets.get("UPGRADE_PASSWORD", "Patwitsafe")
OFFICER_ACCOUNTS = st.secrets.get("OFFICER_ACCOUNTS", {})

LOGO_PATH = next((f for f in glob.glob(os.path.join(BASE_DIR, "school_logo*")) if os.path.isfile(f)), 
                 next((f for f in ["logo.png", "logo.jpg", "logo"] if os.path.exists(f)), None))
LOGO_BASE64 = ""
if LOGO_PATH and os.path.exists(LOGO_PATH):
    with open(LOGO_PATH, "rb") as f: LOGO_BASE64 = base64.b64encode(f.read()).decode()

def get_now_th(): return datetime.now(pytz.timezone('Asia/Bangkok'))
def clean_val(val): return str(val).strip() if not pd.isna(val) else ""
def calculate_pagination(key, total_items, limit=5):
    if key not in st.session_state: st.session_state[key] = 1
    total_pages = math.ceil(total_items / limit) or 1
    if st.session_state[key] > total_pages: st.session_state[key] = 1
    start_idx = (st.session_state[key] - 1) * limit
    end_idx = start_idx + limit
    return start_idx, end_idx, st.session_state[key], total_pages

# --- UNIVERSAL CONNECTOR ---
def connect_gsheet_universal():
    if "textkey" in st.secrets and "json_content" in st.secrets["textkey"]:
        try:
            key_str = st.secrets["textkey"]["json_content"].strip()
            if key_str.startswith(("'","\"")): key_str = key_str[1:-1]
            try: creds_dict = json.loads(key_str, strict=False)
            except: creds_dict = json.loads(key_str.replace('\n', '\\n'), strict=False)
            scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
            creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
            return gspread.authorize(creds).open(SHEET_NAME_TRAFFIC).sheet1
        except: pass
    if "connections" in st.secrets and "gsheets" in st.secrets["connections"]:
        creds_dict = dict(st.secrets["connections"]["gsheets"])
        scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
        return gspread.authorize(creds).open(SHEET_NAME_TRAFFIC).sheet1
    raise Exception("Credential Error")

# ==========================================
# 2. MODULE: INVESTIGATION (‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö 100%)
# ==========================================
def investigation_module():
    user = st.session_state.user_info
    c_brand, c_nav = st.columns([7, 2.5])
    with c_brand:
        c_logo, c_text = st.columns([1, 6])
        with c_logo: 
            if LOGO_PATH: st.image(LOGO_PATH, use_column_width=True)
        with c_text:
            st.markdown(f'<div style="display: flex; flex-direction: column; justify-content: center; height: 100%;"><div style="font-size: 22px; font-weight: bold; color: #1E3A8A; line-height: 1.2;">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div><div style="font-size: 16px; color: #475569; margin-top: 4px;"><span style="font-weight: bold;">üïµÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô</span> | ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ: {user["name"]}</div></div>', unsafe_allow_html=True)
    with c_nav:
        st.write(""); st.write("")
        b_home, b_logout = st.columns(2)
        if b_home.button("üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å", key="inv_h"): setattr(st.session_state, 'current_dept', None); st.rerun()
        if b_logout.button("üö™ ‡∏≠‡∏≠‡∏Å", key="inv_o"): st.session_state.clear(); st.rerun()
    st.markdown("---")

    conn = st.connection("gsheets", type=GSheetsConnection)
    try:
        df_raw = conn.read(ttl="0")
        df_display = df_raw.copy().fillna("")
        if st.session_state.view_mode == "list":
            tab_list, tab_dash = st.tabs(["üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏", "üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î"])
            with tab_list:
                c_search, c_btn_search, c_btn_clear = st.columns([3, 1, 1])
                search_q = c_search.text_input("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", key="inv_q", label_visibility="collapsed")
                c_btn_search.button("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")
                if c_btn_clear.button("‚ùå ‡∏•‡πâ‡∏≤‡∏á"): st.rerun()
                filtered = df_display.copy()
                if search_q: filtered = filtered[filtered.apply(lambda r: r.astype(str).str.contains(search_q, case=False).any(), axis=1)]
                df_p = filtered[filtered['Status'].isin(["‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"])][::-1]
                for i, row in df_p.head(10).iterrows():
                    st.button(f"üìù {row['Report_ID']} | {row['Incident_Type']}", key=f"inv_p_{i}", on_click=lambda r=row['Report_ID']: st.session_state.update({'selected_case_id': r, 'view_mode': 'detail'}))
            with tab_dash:
                st.bar_chart(df_display['Incident_Type'].value_counts())
        elif st.session_state.view_mode == "detail":
            if st.button("‚¨ÖÔ∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö"): st.session_state.view_mode = "list"; st.rerun()
            st.write(f"‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™: {st.session_state.selected_case_id}")
    except Exception as e: st.error(f"Error: {e}")

# ==========================================
# 3. MODULE: TRAFFIC (‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö 100%)
# ==========================================
def traffic_module():
    user = st.session_state.user_info
    c_brand, c_nav = st.columns([7, 2.5])
    with c_brand:
        c_logo, c_text = st.columns([1, 6])
        with c_logo: 
            if LOGO_PATH: st.image(LOGO_PATH, use_column_width=True)
        with c_text:
            st.markdown(f'<div style="display: flex; flex-direction: column; justify-content: center; height: 100%;"><div style="font-size: 22px; font-weight: bold; color: #1E3A8A; line-height: 1.2;">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div><div style="font-size: 16px; color: #475569; margin-top: 4px;"><span style="font-weight: bold;">üö¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£</span> | ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ: {user["name"]}</div></div>', unsafe_allow_html=True)
    with c_nav:
        st.write(""); st.write("")
        b_home, b_logout = st.columns(2)
        if b_home.button("üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å", key="tra_h"): setattr(st.session_state, 'current_dept', None); st.rerun()
        if b_logout.button("üö™ ‡∏≠‡∏≠‡∏Å", key="tra_o"): st.session_state.clear(); st.rerun()
    st.markdown("---")

    if st.session_state.df_tra is None:
        try:
            sheet = connect_gsheet_universal(); vals = sheet.get_all_values()
            if len(vals) > 1: st.session_state.df_tra = pd.DataFrame(vals[1:], columns=[f"C{i}" for i, h in enumerate(vals[0])])
        except: pass
    
    if st.session_state.df_tra is not None:
        q = st.text_input("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)", key="tra_q")
        if q:
            res = st.session_state.df_tra[st.session_state.df_tra.iloc[:, [1, 2, 6]].apply(lambda r: r.astype(str).str.contains(q, case=False).any(), axis=1)]
            for i, row in res.head(5).iterrows():
                with st.expander(f"üìç {row['C6']} | {row['C1']}"):
                    st.write(f"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {row['C13']}")

# ==========================================
# 4. NEW MODULE: BEHAVIORAL ANALYTICS (‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà)
# ==========================================
def analytics_module():
    user = st.session_state.user_info
    # Header
    c_brand, c_nav = st.columns([7, 2.5])
    with c_brand:
        c_logo, c_text = st.columns([1, 6])
        with c_logo: 
            if LOGO_PATH: st.image(LOGO_PATH, use_column_width=True)
        with c_text:
            st.markdown(f'<div style="display: flex; flex-direction: column; justify-content: center; height: 100%;"><div style="font-size: 22px; font-weight: bold; color: #1E3A8A; line-height: 1.2;">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô</div><div style="font-size: 16px; color: #475569; margin-top: 4px;"><span style="font-weight: bold;">üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (Analytics)</span> | ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç: {user["name"]}</div></div>', unsafe_allow_html=True)
    with c_nav:
        st.write(""); st.write("")
        b_home, b_logout = st.columns(2)
        if b_home.button("üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å", key="ana_h"): setattr(st.session_state, 'current_dept', None); st.rerun()
        if b_logout.button("üö™ ‡∏≠‡∏≠‡∏Å", key="ana_o"): st.session_state.clear(); st.rerun()
    st.markdown("---")

    # --- Data Integration (Read-Only) ---
    with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Big Data..."):
        try:
            # 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô
            conn = st.connection("gsheets", type=GSheetsConnection)
            df_inv = conn.read(ttl="0").fillna("")
            # 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏≤‡∏à‡∏£
            sheet_tra = connect_gsheet_universal()
            vals_tra = sheet_tra.get_all_values()
            df_tra = pd.DataFrame(vals_tra[1:], columns=vals_tra[0]) if len(vals_tra) > 1 else pd.DataFrame()
            
            if df_inv.empty and df_tra.empty:
                st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå")
                return

            # --- Layout 1: Holistic Overview ---
            st.markdown("### üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏ß‡∏° (Holistic Overview)")
            m1, m2, m3, m4 = st.columns(4)
            with m1: st.markdown(f'<div class="metric-card"><div class="metric-value">{len(df_inv)}</div><div class="metric-label">‡∏Ñ‡∏î‡∏µ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏£‡∏ß‡∏°</div></div>', unsafe_allow_html=True)
            with m2: st.markdown(f'<div class="metric-card"><div class="metric-value">{len(df_tra)}</div><div class="metric-label">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div></div>', unsafe_allow_html=True)
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Column ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
            avg_score = 0
            if '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' in df_tra.columns:
                avg_score = pd.to_numeric(df_tra['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'], errors='coerce').mean()
            with m3: st.markdown(f'<div class="metric-card"><div class="metric-value">{avg_score:.1f}</div><div class="metric-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div></div>', unsafe_allow_html=True)
            with m4:
                # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏Å‡∏≤‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Column)
                if '‡∏´‡∏°‡∏ß‡∏Å‡∏Å‡∏±‡∏ô‡∏ô‡πá‡∏≠‡∏Ñ' in df_tra.columns:
                    helmet_pct = (df_tra['‡∏´‡∏°‡∏ß‡∏Å‡∏Å‡∏±‡∏ô‡∏ô‡πá‡∏≠‡∏Ñ'].str.contains("‡∏°‡∏µ|‚úÖ").sum() / len(df_tra)) * 100 if len(df_tra)>0 else 0
                    st.markdown(f'<div class="metric-card"><div class="metric-value">{helmet_pct:.1f}%</div><div class="metric-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏Å</div></div>', unsafe_allow_html=True)

            st.write("")

            # --- Layout 2: Deep Analysis Tabs ---
            tab1, tab2, tab3 = st.tabs(["üïí ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà", "üìö ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô", "üõ°Ô∏è ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô"])

            with tab1:
                col_a1, col_a2 = st.columns(2)
                with col_a1:
                    st.markdown("**üîπ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (Incident Distribution)**")
                    if 'Incident_Type' in df_inv.columns:
                        fig_inv = px.pie(df_inv, names='Incident_Type', hole=0.4, color_discrete_sequence=px.colors.qualitative.Pastel)
                        st.plotly_chart(fig_inv, use_container_width=True)
                with col_a2:
                    st.markdown("**üîπ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ (Temporal Trend)**")
                    if 'Timestamp' in df_inv.columns:
                        df_inv['date'] = pd.to_datetime(df_inv['Timestamp']).dt.date
                        trend = df_inv.groupby('date').size().reset_index(name='counts')
                        fig_trend = px.line(trend, x='date', y='counts', markers=True, line_shape='spline')
                        st.plotly_chart(fig_trend, use_container_width=True)

            with tab2:
                st.markdown("**üîπ ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (Behavior by Grade)**")
                # ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô
                if '‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á' in df_tra.columns and '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' in df_tra.columns:
                    df_tra['Level'] = df_tra['‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á'].apply(lambda x: str(x).split('/')[0])
                    df_tra['Score_Num'] = pd.to_numeric(df_tra['‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô'], errors='coerce')
                    lv_analysis = df_tra.groupby('Level')['Score_Num'].mean().sort_values().reset_index()
                    fig_lv = px.bar(lv_analysis, x='Level', y='Score_Num', color='Score_Num', 
                                   title="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô", color_continuous_scale='RdYlGn')
                    st.plotly_chart(fig_lv, use_container_width=True)

            with tab3:
                st.markdown("**üîπ ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ (Prevention Strategy)**")
                c_p1, c_p2 = st.columns([1, 1])
                with c_p1:
                    st.info("""
                    **üìä ‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥:**
                    ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏Å‡∏Å‡∏±‡∏ô‡∏ô‡πá‡∏≠‡∏Ñ 
                    ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Correlation) ‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                    """)
                with c_p2:
                    st.warning("""
                    **üõ°Ô∏è ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô:**
                    1. ‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡∏™‡∏≤‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 07:45 - 08:15 ‡∏ô.
                    2. ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏ì‡∏£‡∏á‡∏Ñ‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 80
                    """)
                
                # ‡∏Å‡∏£‡∏≤‡∏ü Radar (‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏≠)
                categories = ['‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏à‡∏£‡∏≤‡∏à‡∏£', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏û‡∏§‡∏ï‡∏¥', '‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå']
                fig_radar = go.Figure()
                fig_radar.add_trace(go.Scatterpolar(r=[avg_score, 85, 90, 95], theta=categories, fill='toself', name='‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'))
                st.plotly_chart(fig_radar, use_container_width=True)

        except Exception as e:
            st.error(f"‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")

# ==========================================
# 5. MAIN ENTRY
# ==========================================
def main():
    if 'timeout_msg' in st.session_state and st.session_state.timeout_msg:
        st.error(st.session_state.timeout_msg); del st.session_state.timeout_msg

    if not st.session_state.logged_in:
        _, col, _ = st.columns([1, 1.2, 1])
        with col:
            st.markdown("<br><br>", unsafe_allow_html=True)
            with st.container(border=True):
                if LOGO_PATH: st.image(LOGO_PATH, width=120)
                st.markdown("<h3 style='text-align:center;'>‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á<br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</h3>", unsafe_allow_html=True)
                pwd_in = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", type="password")
                if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", width='stretch', type='primary'):
                    if pwd_in in OFFICER_ACCOUNTS:
                        st.session_state.logged_in = True; st.session_state.user_info = OFFICER_ACCOUNTS[pwd_in]
                        st.session_state.current_user_pwd = pwd_in; st.rerun()
                    else: st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î")
    else:
        if st.session_state.current_dept is None:
            c_brand, c_nav = st.columns([7, 2.5])
            with c_brand:
                c_logo, c_text = st.columns([1, 6])
                with c_logo: 
                    if LOGO_PATH: st.image(LOGO_PATH, use_column_width=True)
                with c_text:
                    st.markdown('<div style="display: flex; flex-direction: column; justify-content: center; height: 100%;"><div style="font-size: 22px; font-weight: bold; color: #1E3A8A; line-height: 1.2;">‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏ô‡∏ó‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</div><div style="font-size: 16px; color: #475569; margin-top: 4px;">üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div></div>', unsafe_allow_html=True)
            with c_nav:
                st.write(""); st.write("")
                if st.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", key="main_logout", use_container_width=True):
                    st.session_state.clear(); st.rerun()
            st.markdown("---")
            
            c1, c2, c3 = st.columns(3)
            with c1:
                with st.container(border=True):
                    st.subheader("üïµÔ∏è ‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", use_container_width=True, type='primary'): st.session_state.current_dept = "inv"; st.rerun()
            with c2:
                with st.container(border=True):
                    st.subheader("üö¶ ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£", use_container_width=True, type='primary'): st.session_state.current_dept = "tra"; st.session_state.traffic_page = 'teacher'; st.rerun()
            with c3:
                with st.container(border=True):
                    st.subheader("üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Analytics", use_container_width=True, type='primary'): st.session_state.current_dept = "ana"; st.rerun()
        else:
            if st.session_state.current_dept == "inv": investigation_module()
            elif st.session_state.current_dept == "tra": traffic_module()
            elif st.session_state.current_dept == "ana": analytics_module()

if __name__ == "__main__": main()
