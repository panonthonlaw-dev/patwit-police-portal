import streamlit as st
import pandas as pd
from streamlit_gsheets import GSheetsConnection
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import pytz, random, os, base64, io, qrcode, glob, math, json, requests, re, textwrap, time
from PIL import Image

# PDF Libraries
try:
    from weasyprint import HTML, CSS
    from weasyprint.text.fonts import FontConfiguration
except:
    pass
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4
from reportlab.lib.utils import ImageReader
import plotly.express as px

# ==========================================
# 1. INITIAL SETTINGS & SESSION STATE
# ==========================================
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

# ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error: Initialize Session State
if "logged_in" not in st.session_state: st.session_state.logged_in = False
if "current_user" not in st.session_state: st.session_state.current_user = None
if "current_dept" not in st.session_state: st.session_state.current_dept = None
if "view_mode" not in st.session_state: st.session_state.view_mode = "list"
if "selected_case_id" not in st.session_state: st.session_state.selected_case_id = None
if "page_pending" not in st.session_state: st.session_state.page_pending = 1
if "page_finished" not in st.session_state: st.session_state.page_finished = 1

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
FONT_FILE = os.path.join(BASE_DIR, "THSarabunNew.ttf")

# ==========================================
# 2. SHARED HELPERS (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á)
# ==========================================
def get_now_th():
    return datetime.now(pytz.timezone('Asia/Bangkok'))

def get_img_link_drive(url):
    """‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Error: The truth value of a Series is ambiguous"""
    if pd.isna(url) or str(url).strip() == "" or str(url) == "nan":
        return "https://via.placeholder.com/150?text=No+Image"
    url_str = str(url)
    match = re.search(r'/d/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)', url_str)
    if match:
        file_id = match.group(1) or match.group(2)
        return f"https://drive.google.com/thumbnail?id={file_id}&sz=w800"
    return url_str

def get_base64_image(image_path):
    if not image_path or not os.path.exists(image_path): return ""
    with open(image_path, "rb") as f: return base64.b64encode(f.read()).decode()

# ==========================================
# 3. INVESTIGATION MODULE (‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô)
# ==========================================
def investigation_module():
    st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å", width='stretch', on_click=lambda: setattr(st.session_state, 'current_dept', None))
    st.title("üìÇ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
    
    conn = st.connection("gsheets", type=GSheetsConnection)
    
    # ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î Logic ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    try:
        df_raw = conn.read(ttl="0")
        st.success("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        st.dataframe(df_raw.head(), width='stretch')
        # ... (‡πÉ‡∏™‡πà‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ...
    except Exception as e:
        st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÑ‡∏î‡πâ: {e}")

# ==========================================
# 4. TRAFFIC MODULE (‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£)
# ==========================================
def traffic_module():
    st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å", width='stretch', on_click=lambda: setattr(st.session_state, 'current_dept', None))
    st.title("üö¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")
    
    def connect_traffic():
        key_content = st.secrets["textkey"]["json_content"]
        key_dict = json.loads(key_content.replace('\n', '\\n'), strict=False)
        scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
        creds = ServiceAccountCredentials.from_json_keyfile_dict(key_dict, scope)
        return gspread.authorize(creds).open("Motorcycle_DB").sheet1

    try:
        sheet = connect_traffic()
        st.success("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        # ... (‡πÉ‡∏™‡πà‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡∏ï‡∏±‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ...
    except Exception as e:
        st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏≤‡∏à‡∏£‡πÑ‡∏î‡πâ: {e}")

# ==========================================
# 5. MAIN GATEWAY (‡∏´‡∏ô‡πâ‡∏≤ LOGIN & PORTAL)
# ==========================================
def main():
    if not st.session_state.logged_in:
        st.markdown("<br><br>", unsafe_allow_html=True)
        _, col, _ = st.columns([1, 1.2, 1])
        with col:
            with st.container(border=True):
                st.header("üîê Central Login")
                pwd = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà", type="password")
                if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", width='stretch', type='primary'):
                    accounts = st.secrets.get("officer_accounts", {})
                    if pwd in accounts:
                        st.session_state.logged_in = True
                        st.session_state.current_user = accounts[pwd]
                        st.rerun()
                    else:
                        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
    else:
        # Sidebar ‡∏´‡∏•‡∏±‡∏á Login
        user_info = st.session_state.current_user
        name = user_info['name'] if isinstance(user_info, dict) else str(user_info)
        st.sidebar.write(f"üë§ **{name}**")
        
        if st.sidebar.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", width='stretch'):
            st.session_state.clear()
            st.rerun()

        if st.session_state.current_dept is None:
            st.title("üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô")
            st.write("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô")
            
            c1, c2 = st.columns(2)
            with c1:
                with st.container(border=True):
                    st.subheader("üïµÔ∏è ‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", width='stretch'):
                        st.session_state.current_dept = "inv"
                        st.rerun()
            with c2:
                with st.container(border=True):
                    st.subheader("üö¶ ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")
                    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£", width='stretch'):
                        st.session_state.current_dept = "tra"
                        st.rerun()
        else:
            if st.session_state.current_dept == "inv": investigation_module()
            else: traffic_module()

if __name__ == "__main__":
    main()
