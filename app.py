import streamlit as st
import pandas as pd
from datetime import datetime
import pytz, random, os, base64, io, qrcode, re, time
from PIL import Image

# --- Libraries ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF & Visualization ---
try:
    from weasyprint import HTML, CSS
except ImportError:
    pass # ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå PDF ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô

import gspread
from oauth2client.service_account import ServiceAccountCredentials
import plotly.express as px
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.pagesizes import A4
from reportlab.lib.utils import ImageReader
from streamlit_gsheets import GSheetsConnection

# ==========================================
# 1. INITIAL SETTINGS & SESSION STATE
# ==========================================
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", page_icon="üëÆ‚Äç‚ôÇÔ∏è", layout="wide")

# ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error: AttributeError: st.session_state has no attribute...
if "logged_in" not in st.session_state:
    st.session_state.logged_in = False
if "user_info" not in st.session_state:
    st.session_state.user_info = None
if "current_dept" not in st.session_state:
    st.session_state.current_dept = None
if "search_results" not in st.session_state:
    st.session_state.search_results = None

# ==========================================
# 2. SHARED HELPERS (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á)
# ==========================================
def get_now_th():
    return datetime.now(pytz.timezone('Asia/Bangkok'))

def get_img_link_drive(url):
    """‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Error ValueError: The truth value of a Series is ambiguous"""
    if pd.isna(url) or str(url).strip() == "" or str(url) == "nan":
        return "https://via.placeholder.com/150?text=No+Image"
    
    url_str = str(url)
    # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ File ID ‡∏à‡∏≤‡∏Å Link Google Drive
    match = re.search(r'/d/([a-zA-Z0-9_-]+)|id=([a-zA-Z0-9_-]+)', url_str)
    if match:
        file_id = match.group(1) or match.group(2)
        return f"https://drive.google.com/thumbnail?id={file_id}&sz=w800"
    return url_str

# ==========================================
# 3. INVESTIGATION MODULE (‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô)
# ==========================================
def investigation_module():
    st.sidebar.markdown("### üìÅ ‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
    if st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å", width='stretch'):
        st.session_state.current_dept = None
        st.rerun()
    
    st.title("üïµÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô")
    user = st.session_state.user_info
    st.write(f"‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£: **{user['name']}**")
    
    # --- ‡πÉ‡∏™‡πà Code ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ---
    st.info("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô...")
    # (Copy ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô Dashboard ‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô‡∏°‡∏≤‡∏ß‡∏≤‡∏á)

# ==========================================
# 4. TRAFFIC MODULE (‡∏ù‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏≤‡∏à‡∏£)
# ==========================================
def traffic_module():
    st.sidebar.markdown("### üö¶ ‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏£‡∏≤‡∏à‡∏£")
    if st.sidebar.button("‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å", width='stretch'):
        st.session_state.current_dept = None
        st.rerun()
        
    st.title("üèçÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£")
    
    # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
    try:
        # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GSheet (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å secrets[textkey])
        # ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏≤‡∏à‡∏£‡πÄ‡∏î‡∏¥‡∏°) ...
        st.success("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    except Exception as e:
        st.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: {e}")

# ==========================================
# 5. MAIN GATEWAY (‡∏´‡∏ô‡πâ‡∏≤ Login & ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å)
# ==========================================
def main():
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if not st.session_state.logged_in:
        st.markdown("<br><br>", unsafe_allow_html=True)
        _, col, _ = st.columns([1, 1.5, 1])
        with col:
            with st.container(border=True):
                st.header("üîê ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö")
                pwd = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß", type="password")
                if st.button("Login", width='stretch', type='primary'):
                    accounts = st.secrets.get("officer_accounts", {})
                    if pwd in accounts:
                        st.session_state.logged_in = True
                        st.session_state.user_info = accounts[pwd]
                        st.rerun()
                    else:
                        st.error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")
    else:
        # ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á Login
        st.sidebar.title(f"üë§ {st.session_state.user_info['name']}")
        if st.sidebar.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", width='stretch'):
            st.session_state.clear()
            st.rerun()

        # ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å
        if st.session_state.current_dept is None:
            st.title("üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô")
            st.write("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á")
            
            c1, c2 = st.columns(2)
            # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Error: ‡∏•‡∏ö height=100 ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ width='stretch'
            if c1.button("üïµÔ∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô", width='stretch'):
                st.session_state.current_dept = "investigation"
                st.rerun()
            
            if c2.button("üö¶ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏≤‡∏à‡∏£", width='stretch'):
                st.session_state.current_dept = "traffic"
                st.rerun()
        else:
            # ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if st.session_state.current_dept == "investigation":
                investigation_module()
            else:
                traffic_module()

if __name__ == "__main__":
    main()
